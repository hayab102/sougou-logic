name: V4 Logic Daily (Production)

on:
  workflow_dispatch:
  schedule:
    - cron: "10 0 * * 1-5"  # 平日 09:10 JST（UTC 00:10）

jobs:
  v4:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ① 全銘柄リスト生成（本番）
      - name: Build ticker_list.csv
        run: |
          python get_all_tickers.py
          python stock_csv_generator.py

      # ② 全銘柄の直近だけ取得 → 直近120営業日で計算 → LOGIC_v4へ
      - name: Run v4 pipeline (no raw storage)
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          SHEET_ID_LOGIC:     ${{ secrets.SHEET_ID_LOGIC }}
          LOGIC_SHEET_NAME:   LOGIC_v4
          TICKER_LIST_CSV:    ticker_list.csv

          WINDOW_DAYS:        "120"
          LOOKAHEAD_DAYS:     "7"
          FETCH_CAL_DAYS:     "300"
          BATCH_SIZE:         "40"
          TOP_N:              "200"
        run: |
          python v4_pipeline_daily.py
